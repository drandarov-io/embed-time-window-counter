<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Embeddable time window counter</title>
    <link rel="stylesheet" href="./style.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
<script>
    const params = new URLSearchParams(document.location.search);
    const start_hour = params.get("start_hour");
    const end_hour = params.get("end_hour");

    console.info(start_hour);
    console.info(end_hour);

    var scriptName = "embed.js"; //name of this script, used to get reference to own tag
    var jQuery; //noconflict reference to jquery
    var jqueryPath = "https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js";
    var jqueryVersion = "1.8.3";
    var scriptTag; //reference to the html script tag

    /******** Get reference to self (scriptTag) *********/
    var allScripts = document.getElementsByTagName('script');
    var targetScripts = [];
    for (var i in allScripts) {
        var name = allScripts[i].src
        if (name && name.indexOf(scriptName) > 0)
            targetScripts.push(allScripts[i]);
    }

    scriptTag = targetScripts[targetScripts.length - 1];

    /******** helper function to load external scripts *********/
    function loadScript(src, onLoad) {
        var script_tag = document.createElement('script');
        script_tag.setAttribute("type", "text/javascript");
        script_tag.setAttribute("src", src);

        if (script_tag.readyState) {
            script_tag.onreadystatechange = function () {
                if (this.readyState === 'complete' || this.readyState === 'loaded') {
                    onLoad();
                }
            };
        } else {
            script_tag.onload = onLoad;
        }
        (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(script_tag);
    }

    /******** helper function to load external css  *********/
    function loadCss(href) {
        var link_tag = document.createElement('link');
        link_tag.setAttribute("type", "text/css");
        link_tag.setAttribute("rel", "stylesheet");
        link_tag.setAttribute("href", href);
        (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(link_tag);
    }

    /******** load jquery into 'jQuery' variable then call main ********/
    if (window.jQuery === undefined || window.jQuery.fn.jquery !== jqueryVersion) {
        loadScript(jqueryPath, initjQuery);
    } else {
        initjQuery();
    }

    function initjQuery() {
        jQuery = window.jQuery.noConflict(true);
        main();
    }

    function add_time_range_counter() {

        element = document.getElementById("widget_content")

        function update_time() {

            // Set the date we're counting down to
            var now = new Date();
            console.log("NOW: " + now)

            var start_date = new Date();
            start_date.setHours(start_hour);
            start_date.setMinutes(0);
            start_date.setSeconds(0);

            var end_date = new Date();
            end_date.setHours(end_hour);
            end_date.setMinutes(0);
            end_date.setSeconds(0);

            var countdown_date

            if (start_date < now & now < end_date) {
                element.setAttribute("class", "inside")
                countdown_date = end_date
                console.log("IN WINDOW: " + countdown_date)
            } else if (now > end_date) {
                element.setAttribute("class", "outside")
                start_date.setDate(start_date.getDate() + 1)
                countdown_date = start_date
                console.log("AFTER WINDOW: " + countdown_date)
            } else if (start_date > now) {
                element.setAttribute("class", "outside")
                countdown_date = start_date
                console.log("BEFORE WINDOW: " + countdown_date)
            }

            // Find the distance between now and the count down date
            var distance = countdown_date - now.getTime();

            // Time calculations for days, hours, minutes and seconds
            var days = Math.floor(distance / (1000 * 60 * 60 * 24));
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            //var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Display the result in the element with id="demo"
            element = document.getElementById("widget_content")
            element.innerHTML = days + "d " + hours + "h " + minutes + "m" //+ seconds + "s ";

            // If the count down is finished, write some text
            if (distance < 0) {
                clearInterval(x);
                document.getElementById("widget_content").innerHTML = "EXPIRED";
            }
        }

        update_time()

        // Update the count down every 60 seconds
        var x = setInterval(update_time, 60000);
    }

    function main() {
        //your widget code goes here

        jQuery(document).ready(function ($) {
            //or you could wait until the page is ready

            add_time_range_counter()

            //example load css
            //loadCss("http://example.com/widget.css");

            //example script load
            //loadScript("http://example.com/anotherscript.js", function() { /* loaded */ });
        });
    }
</script>

<div id="widget_content"></div>

</body>
</html>
